#!/usr/bin/env bash
#
# rotate-secret - Seamless API key rotation for Secrets Proxy
# https://github.com/krustybot/rotate-secret
#
# Usage: rotate-secret <service> [options]
#        echo "new_key" | rotate-secret <service> --stdin
#
# DEFAULTS TO DRY-RUN MODE. Pass --apply to execute.

# Check bash version (associative arrays require 4.0+)
if [[ "${BASH_VERSINFO[0]}" -lt 4 ]]; then
    echo "Error: This script requires bash 4.0 or newer."
    echo "You have: Bash ${BASH_VERSION}"
    echo ""
    echo "On macOS, install a newer bash:"
    echo "  brew install bash"
    echo ""
    echo "Then run with: /opt/homebrew/bin/bash rotate-secret ..."
    echo "Or add to your PATH: export PATH=\"/opt/homebrew/bin:\$PATH\""
    exit 1
fi

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="${HOME}/.config/rotate-secret"
CONFIG_FILE="${CONFIG_DIR}/config.sh"

# Default settings (can be overridden in config)
AGE_PUBKEY="${AGE_PUBKEY:-age14ypvy9kly6hgfap3ydpfxcwxnu6qnwg5e08e0aet0ywtagwm5gtqt34a4e}"
SCOUT_HOST="${SCOUT_HOST:-scout.fable-court.ts.net}"
SCOUT_SSH_PORT="${SCOUT_SSH_PORT:-2222}"
SCOUT_SECRETS_DIR="/opt/secrets"
SCOUT_PROXY_CONFIG="/opt/secrets-proxy/config.yaml"
OP_VAULT="${OP_VAULT:-Agent}"

# Service → 1Password UUID mapping (will be populated from config or detected)
declare -A OP_ITEMS
OP_ITEMS[fireworks]="tv4ckdwgtpafjysefugees5lvi"
OP_ITEMS[github]="po2msout5lxr36lg5nxpg2kw4e"
OP_ITEMS[huggingface]="75ed2muaou6nfvwystetrnx3ri"
OP_ITEMS[repliers]="weaauihh4zulalsf7mdw2nsxya"
OP_ITEMS[runpod]="a4hrhm3djes2drri4rqff6l47y"
OP_ITEMS[elevenlabs]="nqdvu7j7hjplm6zbpgktlfjazq"
OP_ITEMS[gemini]="nhueno5zhkiz35rkbqsidz5ow4"
OP_ITEMS[goplaces]="vm4nngozu4r3bob5k6ttgm3aaa"
OP_ITEMS[openai]="2hkcz4svzobgy2wtcluqrz6gdm"

# Service → verification endpoint mapping
declare -A VERIFY_ENDPOINTS
VERIFY_ENDPOINTS[fireworks]="/proxy/fireworks/v1/models"
VERIFY_ENDPOINTS[github]="/proxy/github/user"
VERIFY_ENDPOINTS[huggingface]="/proxy/huggingface/api/whoami-v2"
VERIFY_ENDPOINTS[repliers]="/proxy/repliers/listings"
VERIFY_ENDPOINTS[runpod]="/proxy/runpod/graphql"
VERIFY_ENDPOINTS[elevenlabs]="/proxy/elevenlabs/v1/voices"
VERIFY_ENDPOINTS[gemini]="/proxy/gemini/v1beta/models"
VERIFY_ENDPOINTS[goplaces]="/proxy/goplaces/v1/places:searchText"
VERIFY_ENDPOINTS[openai]="/proxy/openai/v1/models"

# Script state
DRY_RUN=true
USE_STDIN=false
NEW_KEY=""
SERVICE=""

# Functions
log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✅${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}❌${NC} $1"; }

show_help() {
    cat << 'EOF'
rotate-secret - Seamless API key rotation for Secrets Proxy

USAGE:
    rotate-secret <service> [options]
    echo "new_key" | rotate-secret <service> --stdin

SERVICES:
    fireworks, github, huggingface, repliers, runpod,
    elevenlabs, gemini, goplaces, openai

OPTIONS:
    --apply         Execute the rotation (default is dry-run)
    --stdin         Read new key from stdin instead of prompting
    -h, --help      Show this help message

EXAMPLES:
    # Dry run (default) - see what would happen
    rotate-secret fireworks

    # Actually rotate (after verifying dry-run output)
    rotate-secret fireworks --apply

    # Rotate with pre-pasted key
    pbpaste | rotate-secret fireworks --stdin --apply

    # Bulk rotation
    for svc in fireworks github; do rotate-secret $svc --apply; done

WORKFLOW:
    1. Generate new key in service console (keep tab open)
    2. Run rotate-secret with --apply
    3. Paste new key when prompted (or via --stdin)
    4. Script updates 1Password, deploys to scout, verifies
    5. After success, revoke old key in service console

CONFIG:
    ~/.config/rotate-secret/config.sh

EOF
}

load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

check_dependencies() {
    local missing=()
    
    if ! command -v op &> /dev/null; then
        missing+=("op (1Password CLI)")
    fi
    
    if ! command -v age &> /dev/null; then
        missing+=("age (encryption)")
    fi
    
    if ! command -v ssh &> /dev/null; then
        missing+=("ssh")
    fi
    
    if ! command -v tailscale &> /dev/null && ! command -v ssh &> /dev/null; then
        missing+=("tailscale or ssh access to scout")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing dependencies:"
        for dep in "${missing[@]}"; do
            echo "  - $dep"
        done
        exit 1
    fi
}

validate_service() {
    SERVICE="$1"
    
    if [[ -z "$SERVICE" ]]; then
        log_error "No service specified"
        show_help
        exit 1
    fi
    
    if [[ -z "${OP_ITEMS[$SERVICE]:-}" ]]; then
        log_error "Unknown service: $SERVICE"
        log_info "Known services: ${!OP_ITEMS[*]}"
        exit 1
    fi
}

get_current_key_info() {
    local item_uuid="${OP_ITEMS[$SERVICE]}"
    
    log_info "Looking up 1Password item..."
    
    # Check if 1Password CLI is signed in
    if ! op account list &> /dev/null; then
        log_warn "1Password CLI not authenticated. Please run: op signin"
        exit 1
    fi
    
    # Get item details for dry-run display
    local item_title
    item_title=$(op item get "$item_uuid" --format=json 2>/dev/null | jq -r '.title' || echo "Unknown")
    
    echo ""
    echo "Service: $SERVICE"
    echo "1Password item: $item_uuid"
    echo "1Password title: $item_title"
    echo ""
}

prompt_for_key() {
    if [[ "$USE_STDIN" == true ]]; then
        # Read from stdin
        if ! IFS= read -r NEW_KEY; then
            log_error "Failed to read key from stdin"
            exit 1
        fi
    else
        # Interactive prompt with masked input (show asterisks)
        echo -n "Paste new $SERVICE API key: "
        
        # Disable terminal echo and read character by character
        stty -echo
        NEW_KEY=""
        local char
        while IFS= read -r -n1 char; do
            # Enter key (newline/null) ends input
            if [[ -z "$char" ]] || [[ "$char" == $'\n' ]] || [[ "$char" == $'\r' ]]; then
                break
            fi
            # Handle backspace/delete
            if [[ "$char" == $'\x7f' ]] || [[ "$char" == $'\b' ]]; then
                if [[ ${#NEW_KEY} -gt 0 ]]; then
                    NEW_KEY="${NEW_KEY%?}"
                    echo -ne "\b \b"  # Erase asterisk
                fi
            else
                NEW_KEY+="$char"
                echo -n "*"
            fi
        done
        stty echo
        echo ""  # Newline after input
    fi
    
    if [[ -z "$NEW_KEY" ]]; then
        log_error "No key provided"
        exit 1
    fi
    
    # Basic validation
    if [[ ${#NEW_KEY} -lt 10 ]]; then
        log_warn "Key seems very short (${#NEW_KEY} chars). Are you sure this is correct?"
        echo "Press Ctrl+C to abort, or Enter to continue..."
        read -r
    fi
}

dry_run() {
    local item_uuid="${OP_ITEMS[$SERVICE]}"
    local verify_endpoint="${VERIFY_ENDPOINTS[$SERVICE]:-}"
    
    echo ""
    log_warn "DRY RUN MODE"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Service: $SERVICE"
    echo "1Password item: $item_uuid"
    echo ""
    echo "Would execute:"
    echo "  1. Update 1Password credential field with new key"
    echo "  2. Encrypt with age public key"
    echo "  3. Deploy to scout:${SCOUT_SECRETS_DIR}/${SERVICE}.age"
    echo "  4. Restart secrets-proxy service"
    
    if [[ -n "$verify_endpoint" ]]; then
        echo "  5. Verify with: curl http://${SCOUT_HOST}:8443${verify_endpoint}"
    fi
    
    echo ""
    echo "New key length: ${#NEW_KEY} characters"
    echo "Key prefix: ${NEW_KEY:0:10}****"
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    log_info "Run with --apply to execute"
    echo ""
}

execute_rotation() {
    local item_uuid="${OP_ITEMS[$SERVICE]}"
    local verify_endpoint="${VERIFY_ENDPOINTS[$SERVICE]:-}"
    
    echo ""
    log_info "Executing rotation..."
    echo ""
    
    # Step 1: Update 1Password
    log_info "Step 1/5: Updating 1Password..."
    if ! op item edit "$item_uuid" credential="$NEW_KEY" > /dev/null; then
        log_error "Failed to update 1Password"
        exit 1
    fi
    log_success "1Password updated"
    
    # Step 2 & 3: Encrypt and deploy
    log_info "Step 2-3/5: Encrypting and deploying to scout..."
    
    local tmpfile
    tmpfile=$(mktemp)
    echo "$NEW_KEY" | age -r "$AGE_PUBKEY" -o "$tmpfile"
    
    if ! scp -P "$SCOUT_SSH_PORT" "$tmpfile" "holu@${SCOUT_HOST}:${SCOUT_SECRETS_DIR}/${SERVICE}.age.tmp" 2>/dev/null; then
        # Fallback to ssh cat method
        echo "$NEW_KEY" | age -r "$AGE_PUBKEY" | \
            ssh -p "$SCOUT_SSH_PORT" "holu@${SCOUT_HOST}" "cat > ${SCOUT_SECRETS_DIR}/${SERVICE}.age.tmp"
    fi
    
    # Move into place atomically
    ssh -p "$SCOUT_SSH_PORT" "holu@${SCOUT_HOST}" "sudo mv ${SCOUT_SECRETS_DIR}/${SERVICE}.age.tmp ${SCOUT_SECRETS_DIR}/${SERVICE}.age"
    
    rm -f "$tmpfile"
    log_success "Deployed to scout"
    
    # Step 4: Restart proxy
    log_info "Step 4/5: Restarting secrets-proxy..."
    if ! ssh -p "$SCOUT_SSH_PORT" "holu@${SCOUT_HOST}" "sudo systemctl restart secrets-proxy" > /dev/null 2>&1; then
        log_error "Failed to restart proxy"
        log_info "Try manually: ssh -p $SCOUT_SSH_PORT holu@$SCOUT_HOST 'sudo systemctl restart secrets-proxy'"
        exit 1
    fi
    
    # Wait a moment for service to start
    sleep 2
    log_success "Proxy restarted"
    
    # Step 5: Verify
    if [[ -n "$verify_endpoint" ]]; then
        log_info "Step 5/5: Verifying new key works..."
        
        local verify_url="http://${SCOUT_HOST}:8443${verify_endpoint}"
        local http_code
        http_code=$(curl -s -o /dev/null -w "%{http_code}" "$verify_url" 2>/dev/null || echo "000")
        
        if [[ "$http_code" == "200" ]]; then
            log_success "Verification passed (HTTP 200)"
        elif [[ "$http_code" == "401" ]] || [[ "$http_code" == "403" ]]; then
            log_warn "Verification returned HTTP $http_code - key may be invalid"
            log_info "Check proxy logs: ssh -p $SCOUT_SSH_PORT holu@$SCOUT_HOST 'sudo journalctl -u secrets-proxy -n 20'"
        elif [[ "$http_code" == "000" ]]; then
            log_warn "Could not connect to proxy for verification"
        else
            log_warn "Verification returned HTTP $http_code (unexpected)"
        fi
    else
        log_info "Step 5/5: No verification endpoint configured for $SERVICE"
    fi
    
    echo ""
    log_success "Rotation complete!"
    echo ""
    log_info "ACTION REQUIRED: Revoke the old key in the $SERVICE console"
    echo ""
}

main() {
    # Parse arguments
    local args=()
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --apply)
                DRY_RUN=false
                shift
                ;;
            --stdin)
                USE_STDIN=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                show_help
                exit 1
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done
    
    # Load configuration
    load_config
    
    # Validate service
    if [[ ${#args[@]} -eq 0 ]]; then
        log_error "No service specified"
        show_help
        exit 1
    fi
    SERVICE="${args[0]}"
    validate_service "$SERVICE"
    
    # Check dependencies
    check_dependencies
    
    # Get current info for dry-run display
    get_current_key_info
    
    # Get new key
    prompt_for_key
    
    # Execute or dry-run
    if [[ "$DRY_RUN" == true ]]; then
        dry_run
    else
        execute_rotation
    fi
}

main "$@"
